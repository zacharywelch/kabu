/*! kabu 18-02-2016 */
!function($){"use strict";var defaults={prefilled:null,CapitalizeFirstLetter:!1,preventSubmitOnEnter:!0,isClearInputOnEsc:!0,externalTagId:!1,prefillIdFieldName:"Id",prefillValueFieldName:"Value",AjaxPush:null,AjaxPushAllTags:null,AjaxPushParameters:null,delimiters:[9,13,44],backspace:[8],maxTags:0,hiddenTagListName:null,hiddenTagListId:null,replace:!0,output:null,deleteTagsOnBackspace:!0,tagsContainer:null,tagCloseIcon:"x",tagClass:"dark pad0 small round inline space-bottom0",validator:null,onlyTagList:!1,tagList:null,fillInputOnTagRemove:!1},publicMethods={pushTag:function(tag,ignoreEvents,externalTagId){var alreadyInList,tlisLowerCase,max,tagId,idx,newTagId,newTagRemoveId,escaped,html,$el,lastTagId,lastTagObj,$self=$(this),opts=$self.data("opts"),tlis=$self.data("tlis"),tlid=$self.data("tlid");if(tag=privateMethods.trimTag(tag,opts.delimiterChars),tag&&!(tag.length<=0)){if(opts.onlyTagList&&void 0!==opts.tagList&&opts.tagList){var $tagList=opts.tagList;$.each($tagList,function(index,item){$tagList[index]=item.toLowerCase()});var suggestion=$.inArray(tag.toLowerCase(),$tagList);if(-1===suggestion)return}if(opts.CapitalizeFirstLetter&&tag.length>1&&(tag=tag.charAt(0).toUpperCase()+tag.slice(1).toLowerCase()),opts.validator&&!opts.validator(tag))return void $self.trigger("tm:invalid",tag);if(!(opts.maxTags>0&&tlis.length>=opts.maxTags)){if(alreadyInList=!1,tlisLowerCase=jQuery.map(tlis,function(elem){return elem.toLowerCase()}),idx=$.inArray(tag.toLowerCase(),tlisLowerCase),-1!==idx&&(alreadyInList=!0),alreadyInList)if($self.trigger("tm:duplicated",tag),opts.blinkClass)for(var i=0;6>i;++i)$("#"+$self.data("tm_rndid")+"_"+tlid[idx]).queue(function(next){$(this).toggleClass(opts.blinkClass),next()}).delay(100);else $("#"+$self.data("tm_rndid")+"_"+tlid[idx]).stop().animate({backgroundColor:opts.blinkBGColor_1},100).animate({backgroundColor:opts.blinkBGColor_2},100).animate({backgroundColor:opts.blinkBGColor_1},100).animate({backgroundColor:opts.blinkBGColor_2},100).animate({backgroundColor:opts.blinkBGColor_1},100).animate({backgroundColor:opts.blinkBGColor_2},100);else{opts.externalTagId===!0?(void 0===externalTagId&&$.error("externalTagId is not passed for tag -"+tag),tagId=externalTagId):(max=Math.max.apply(null,tlid),max=max===-(1/0)?0:max,tagId=++max),ignoreEvents||$self.trigger("tm:pushing",[tag,tagId]),tlis.push(tag),tlid.push(tagId),ignoreEvents||null!==opts.AjaxPush&&null==opts.AjaxPushAllTags&&-1===$.inArray(tag,opts.prefilled)&&$.post(opts.AjaxPush,$.extend({tag:tag},opts.AjaxPushParameters)),newTagId=$self.data("tm_rndid")+"_"+tagId,newTagRemoveId=$self.data("tm_rndid")+"_Remover_"+tagId,escaped=$("<span/>").text(tag).html(),html='<span class="'+privateMethods.tagClasses.call($self)+'" id="'+newTagId+'">',html+="<span>"+escaped+"</span>",html+='<button href="#" class="close" id="'+newTagRemoveId+'" TagIdToRemove="'+tagId+'">',html+=opts.tagCloseIcon+"</button></span> ",$el=$(html);var typeAheadMess=void 0!==$self.parents(".twitter-typeahead")[0];if(null!==opts.tagsContainer)$(opts.tagsContainer).append($el);else if(tlid.length>1)if(typeAheadMess){var lastTagId=$self.data("tm_rndid")+"_"+--tagId;jQuery("#"+lastTagId).after($el)}else lastTagObj=$self.siblings("#"+$self.data("tm_rndid")+"_"+tlid[tlid.length-2]),lastTagObj.after($el);else typeAheadMess?$self.parents(".twitter-typeahead").before($el):$self.before($el);$el.find("#"+newTagRemoveId).on("click",$self,function(e){e.preventDefault();var TagIdToRemove=parseInt($(this).attr("TagIdToRemove"));privateMethods.spliceTag.call($self,TagIdToRemove,e.data)}),privateMethods.refreshHiddenTagList.call($self),ignoreEvents||$self.trigger("tm:pushed",[tag,tagId]),privateMethods.showOrHide.call($self)}$self.val("")}}},popTag:function(){var tagId,tagBeingRemoved,$self=$(this),tlis=$self.data("tlis"),tlid=$self.data("tlid");tlid.length>0&&(tagId=tlid.pop(),tagBeingRemoved=tlis[tlis.length-1],$self.trigger("tm:popping",[tagBeingRemoved,tagId]),tlis.pop(),$("#"+$self.data("tm_rndid")+"_"+tagId).remove(),privateMethods.refreshHiddenTagList.call($self),$self.trigger("tm:popped",[tagBeingRemoved,tagId]))},empty:function(){for(var tagId,$self=$(this),tlis=$self.data("tlis"),tlid=$self.data("tlid");tlid.length>0;)tagId=tlid.pop(),tlis.pop(),$("#"+$self.data("tm_rndid")+"_"+tagId).remove(),privateMethods.refreshHiddenTagList.call($self);$self.trigger("tm:emptied",null),privateMethods.showOrHide.call($self)},tags:function(){var $self=this,tlis=$self.data("tlis");return tlis}},privateMethods={showOrHide:function(){var $self=this,opts=$self.data("opts"),tlis=$self.data("tlis");opts.maxTags>0&&tlis.length<opts.maxTags&&($self.show(),$self.trigger("tm:show")),opts.maxTags>0&&tlis.length>=opts.maxTags&&($self.hide(),$self.trigger("tm:hide"))},tagClasses:function(){var cl,$self=$(this),opts=$self.data("opts"),tagBaseClass=opts.tagBaseClass,inputBaseClass=opts.inputBaseClass;return cl=tagBaseClass,$self.attr("class")&&$.each($self.attr("class").split(" "),function(index,value){-1!==value.indexOf(inputBaseClass+"-")&&(cl+=" "+tagBaseClass+value.substring(inputBaseClass.length))}),cl+=opts.tagClass?" "+opts.tagClass:""},trimTag:function(tag,delimiterChars){var i;for(tag=$.trim(tag),i=0;i<tag.length&&-1===$.inArray(tag.charCodeAt(i),delimiterChars);i++);return tag.substring(0,i)},refreshHiddenTagList:function(){var $self=$(this),tlis=$self.data("tlis"),lhiddenTagList=$self.data("lhiddenTagList");lhiddenTagList&&$(lhiddenTagList).val(tlis.join($self.data("opts").baseDelimiter)).change(),$self.trigger("tm:refresh",tlis.join($self.data("opts").baseDelimiter))},killEvent:function(e){e.cancelBubble=!0,e.returnValue=!1,e.stopPropagation(),e.preventDefault()},keyInArray:function(e,ary){return-1!==$.inArray(e.which,ary)},applyDelimiter:function(e){var $self=$(this);publicMethods.pushTag.call($self,$(this).val()),e.preventDefault()},prefill:function(pta){var $self=$(this),opts=$self.data("opts");$.each(pta,function(key,val){opts.externalTagId===!0?publicMethods.pushTag.call($self,val[opts.prefillValueFieldName],!0,val[opts.prefillIdFieldName]):publicMethods.pushTag.call($self,val,!0)})},pushAllTags:function(e,tag){var $self=$(this),opts=$self.data("opts"),tlis=$self.data("tlis");opts.AjaxPushAllTags&&("tm:pushed"!==e.type||-1===$.inArray(tag,opts.prefilled))&&$.post(opts.AjaxPush,$.extend({tags:tlis.join(opts.baseDelimiter)},opts.AjaxPushParameters))},spliceTag:function(tagId){var tagBeingRemoved,$self=this,tlis=$self.data("tlis"),tlid=$self.data("tlid"),idx=$.inArray(tagId,tlid);-1!==idx&&(tagBeingRemoved=tlis[idx],$self.trigger("tm:splicing",[tagBeingRemoved,tagId]),$("#"+$self.data("tm_rndid")+"_"+tagId).remove(),tlis.splice(idx,1),tlid.splice(idx,1),privateMethods.refreshHiddenTagList.call($self),$self.trigger("tm:spliced",[tagBeingRemoved,tagId])),privateMethods.showOrHide.call($self)},init:function(options){var delimiters,keyNums,opts=$.extend({},defaults,options);return opts.hiddenTagListName=null===opts.hiddenTagListName?"hidden-"+this.attr("name"):opts.hiddenTagListName,delimiters=opts.delimeters||opts.delimiters,keyNums=[9,13,17,18,19,37,38,39,40],opts.delimiterChars=[],opts.delimiterKeys=[],$.each(delimiters,function(i,v){-1!==$.inArray(v,keyNums)?opts.delimiterKeys.push(v):opts.delimiterChars.push(v)}),opts.baseDelimiter=String.fromCharCode(opts.delimiterChars[0]||44),opts.tagBaseClass="tm-tag",opts.inputBaseClass="tm-input",$.isFunction(opts.validator)||(opts.validator=null),this.each(function(){var $self=$(this),hiddenObj="",rndid="",albet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";if($self.data("tagManager"))return!1;$self.data("tagManager",!0);for(var i=0;5>i;i++)rndid+=albet.charAt(Math.floor(Math.random()*albet.length));if($self.data("tm_rndid",rndid),$self.data("opts",opts).data("tlis",[]).data("tlid",[]),null===opts.output?(hiddenObj=$("<input/>",{type:"hidden",name:opts.hiddenTagListName}),$self.after(hiddenObj),$self.data("lhiddenTagList",hiddenObj)):$self.data("lhiddenTagList",$(opts.output)),opts.AjaxPushAllTags&&($self.on("tm:spliced",privateMethods.pushAllTags),$self.on("tm:popped",privateMethods.pushAllTags),$self.on("tm:pushed",privateMethods.pushAllTags)),$self.on("focus keypress",function(e){$(this).popover&&$(this).popover("hide")}),opts.isClearInputOnEsc&&$self.on("keyup",function(e){27===e.which&&($(this).val(""),privateMethods.killEvent(e))}),$self.on("keypress",function(e){privateMethods.keyInArray(e,opts.delimiterChars)&&privateMethods.applyDelimiter.call($self,e)}),$self.on("keydown",function(e){13===e.which&&opts.preventSubmitOnEnter&&privateMethods.killEvent(e),privateMethods.keyInArray(e,opts.delimiterKeys)&&privateMethods.applyDelimiter.call($self,e)}),opts.deleteTagsOnBackspace&&$self.on("keydown",function(e){privateMethods.keyInArray(e,opts.backspace)&&$(this).val().length<=0&&(publicMethods.popTag.call($self),privateMethods.killEvent(e))}),opts.fillInputOnTagRemove&&$self.on("tm:popped",function(e,tag){$(this).val(tag)}),$self.change(function(e){/webkit/.test(navigator.userAgent.toLowerCase())||$self.focus(),privateMethods.killEvent(e)}),null!==opts.prefilled)"object"==typeof opts.prefilled?privateMethods.prefill.call($self,opts.prefilled):"string"==typeof opts.prefilled?privateMethods.prefill.call($self,opts.prefilled.split(opts.baseDelimiter)):"function"==typeof opts.prefilled&&privateMethods.prefill.call($self,opts.prefilled());else if(null!==opts.output){if($(opts.output)&&$(opts.output).val()){$(opts.output)}privateMethods.prefill.call($self,$(opts.output).val().split(opts.baseDelimiter))}}),this}};$.fn.tagsManager=function(method){var $self=$(this);return 0 in this?publicMethods[method]?publicMethods[method].apply($self,Array.prototype.slice.call(arguments,1)):"object"!=typeof method&&method?($.error("Method "+method+" does not exist."),!1):privateMethods.init.apply(this,arguments):this}}(jQuery);